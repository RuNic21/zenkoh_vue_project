---
description: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±åˆãƒ«ãƒ¼ãƒ«ï¼ˆé¸æŠçš„å‚ç…§ï¼‰
---

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±åˆãƒ«ãƒ¼ãƒ« (Database Integration Rules)

## ğŸ“‹ æ¦‚è¦

Zenkoh Project Scheduler ã® Supabase ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±åˆã«é–¢ã™ã‚‹é–‹ç™ºãƒ«ãƒ¼ãƒ«ã¨ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã§ã™ã€‚

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åŸå‰‡

### 1. éšå±¤åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹
```
UI Layer (Vue Components)
    â†“
Store Layer (Pinia/Reactive Store)
    â†“
Service Layer (taskService, projectService)
    â†“
Adapter Layer (taskAdapter)
    â†“
Database Layer (Supabase)
```

### 2. å‹ã‚·ã‚¹ãƒ†ãƒ æ§‹é€ 
- **DBå‹**: `src/types/db/*.ts` (è‡ªå‹•ç”Ÿæˆã€ç·¨é›†ç¦æ­¢)
  - projects.ts, tasks.ts, users.ts, boards.ts, board_columns.ts
  - task_members.ts, notifications.ts, alert_rules.ts
  - project_members.ts, information_schema_columns.ts
- **ãƒ“ã‚¸ãƒã‚¹å‹**: `src/types/task.ts`, `src/types/project.ts` (æ‰‹å‹•å®šç¾©)
- **UIå‹**: `src/types/schedule.ts` (ç”»é¢è¡¨ç¤ºç”¨)
- **å°‚é–€å‹**: `src/types/team.ts`, `src/types/report.ts`, `src/types/notification.ts`
- **è¿½åŠ å‹**: `src/types/comment.ts`, `src/types/taskStatusHistory.ts`

## ğŸ”§ é–‹ç™ºãƒ«ãƒ¼ãƒ«

### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ãƒ«ãƒ¼ãƒ«

#### âœ… æ­£ã—ã„æ–¹æ³•
```typescript
// StoreçµŒç”±ã§ã®ã‚¢ã‚¯ã‚»ã‚¹
const store = useScheduleStore();
await store.loadAll(); // DBã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
await store.save(item); // DBã«ä¿å­˜
await store.create(newItem); // æ–°è¦é …ç›®ä½œæˆ
await store.delete(id); // å‰Šé™¤
```

#### âŒ é¿ã‘ã‚‹ã¹ãæ–¹æ³•
```typescript
// ç›´æ¥Supabaseå‘¼ã³å‡ºã—ï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ï¼‰
const { data } = await supabase.from("tasks").select("*");

// ç›´æ¥ã‚µãƒ¼ãƒ“ã‚¹å‘¼ã³å‡ºã—ï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ï¼‰
const tasks = await listTasks();
```

### 2. å‹å¤‰æ›ãƒ«ãƒ¼ãƒ«

#### Task â†” ScheduleItem å¤‰æ›
```typescript
// DB â†’ UI å¤‰æ›
import { taskToScheduleItem } from "../utils/taskAdapter";
const scheduleItem = taskToScheduleItem(task, users);

// UI â†’ DB å¤‰æ›
import { scheduleItemToTaskUpdate } from "../utils/taskAdapter";
const taskUpdate = scheduleItemToTaskUpdate(scheduleItem);
```

#### çŠ¶æ…‹/å„ªå…ˆåº¦ãƒãƒƒãƒ”ãƒ³ã‚°
```typescript
// DBçŠ¶æ…‹ â†’ æ—¥æœ¬èªUI
"NOT_STARTED" â†’ "äºˆå®š"
"IN_PROGRESS" â†’ "é€²è¡Œä¸­"
"DONE" â†’ "å®Œäº†"
"DELAYED" â†’ "é…å»¶"

// å„ªå…ˆåº¦ãƒãƒƒãƒ”ãƒ³ã‚°
"HIGH" â†’ "é«˜"
"MEDIUM" â†’ "ä¸­"
"LOW" â†’ "ä½"
```

### 3. ã‚¨ãƒ©ãƒ¼å‡¦ç†ãƒ«ãƒ¼ãƒ«

#### ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒ©ãƒ¼å‡¦ç†
```typescript
export async function createTask(payload: TaskInsert): Promise<Task | null> {
  try {
    const { data, error } = await supabase
      .from("tasks")
      .insert([payload])
      .select("*")
      .single();
    
    if (error) {
      console.error("ã‚¿ã‚¹ã‚¯ä½œæˆã«å¤±æ•—:", error.message);
      return null; // nullè¿”å´ã§å¤±æ•—è¡¨ç¤º
    }
    return data as Task;
  } catch (e) {
    const msg = e instanceof Error ? e.message : String(e);
    console.error("ã‚¿ã‚¹ã‚¯ä½œæˆæ™‚ã«äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼:", msg);
    return null;
  }
}
```

#### UIã‚¨ãƒ©ãƒ¼å‡¦ç†
```typescript
const saveChanges = async () => {
  try {
    await store.save({ ...editForm.value });
    // æˆåŠŸå‡¦ç†
  } catch (e) {
    console.error("ä¿å­˜ã«å¤±æ•—", e);
    alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ"); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  }
};
```

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒãƒ«ãƒ¼ãƒ«

### 1. ãƒ†ãƒ¼ãƒ–ãƒ«é–¢ä¿‚
- **PROJECTS** â†’ **TASKS** (1:N)
- **TASKS** â†’ **TASK_MEMBERS** (1:N)
- **USERS** â†’ **TASK_MEMBERS** (1:N)
- **PROJECTS** â†’ **BOARDS** (1:N)
- **BOARDS** â†’ **BOARD_COLUMNS** (1:N)
- **USERS** â†’ **NOTIFICATIONS** (1:N)
- **ALERT_RULES** â†’ **NOTIFICATIONS** (1:N)
- **TASKS** â†’ **TASKS** (è‡ªå·±å‚ç…§: parent_task_id)
- **PROJECTS** â†’ **PROJECT_MEMBERS** (1:N)

### 2. å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ«ãƒ¼ãƒ«
```typescript
// Taskä½œæˆæ™‚ã®å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
interface TaskInsert {
  project_id: number;     // å¿…é ˆ
  task_name: string;      // å¿…é ˆ
  // æ®‹ã‚Šã¯é¸æŠé …ç›®
  status?: string;        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤: "NOT_STARTED"
  priority?: string;      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤: "MEDIUM"
  progress_percent?: number; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤: 0
}
```

### 3. æ—¥ä»˜å½¢å¼ãƒ«ãƒ¼ãƒ«
- **DBä¿å­˜**: ISO 8601å½¢å¼ (`2024-01-15T00:00:00.000Z`)
- **UIè¡¨ç¤º**: YYYY-MM-DDå½¢å¼ (`2024-01-15`)
- **å¤‰æ›**: `taskAdapter.ts`ã§è‡ªå‹•å‡¦ç†

## ğŸ› ï¸ é–‹ç™ºãƒ„ãƒ¼ãƒ«ä½¿ç”¨æ–¹æ³•

### 1. å‹ç”Ÿæˆ
```bash
# Supabaseã‹ã‚‰å‹è‡ªå‹•ç”Ÿæˆ
npm run types:gen

# CSVã‹ã‚‰å‹ç”Ÿæˆ
npm run types:fromcsv
```

### 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ
```bash
# ç’°å¢ƒå¤‰æ•°ãƒ†ã‚¹ãƒˆ
npm run test:env

# CRUDãƒ†ã‚¹ãƒˆ
npm run test:crud:all

# ç‰¹å®šãƒ†ãƒ¼ãƒ–ãƒ«ãƒ†ã‚¹ãƒˆ
npm run test:projects
npm run test:tasks
```

### 3. ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ç®¡ç†
```bash
# å…¨ä½“ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
npm run seed:all

# ç‰¹å®šãƒ†ãƒ¼ãƒ–ãƒ«ã‚·ãƒ¼ãƒ‰
npm run seed:projects
npm run seed:tasks

# CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
npm run export:csv
```

## ğŸ” ãƒ‡ãƒãƒƒã‚°ã‚¬ã‚¤ãƒ‰

### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª
```bash
npm run test:env
# å‡ºåŠ›: "æ¥ç¶šã«æˆåŠŸã—ã¾ã—ãŸ" ã¾ãŸã¯ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```

### 2. ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ç¢ºèª
```bash
npm run debug:count
# å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°å‡ºåŠ›
```

### 3. ãƒ–ãƒ©ã‚¦ã‚¶é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«
```javascript
// StoreçŠ¶æ…‹ç¢ºèª
console.log(store.schedules.value);

// é¸æŠã•ã‚ŒãŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç¢ºèª
console.log(store.selectedSchedule.value);
```

## ğŸ“ ã‚³ãƒ¼ãƒ‰ä½œæˆã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### 1. æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹é–¢æ•°ä½œæˆ
```typescript
// src/services/[serviceName]Service.ts
export async function newServiceFunction(params: SomeType): Promise<ResultType | null> {
  try {
    // Supabaseã‚¯ã‚¨ãƒª
    const { data, error } = await supabase
      .from("table_name")
      .select("*")
      .eq("some_field", params.value);
    
    if (error) {
      console.error("ä½œæ¥­å¤±æ•—:", error.message);
      return null;
    }
    
    return data as ResultType;
  } catch (e) {
    const msg = e instanceof Error ? e.message : String(e);
    console.error("äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼:", msg);
    return null;
  }
}
```

### 2. å°‚é–€ã‚µãƒ¼ãƒ“ã‚¹ä½¿ç”¨ä¾‹
```typescript
// ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆå–å¾—
import { fetchProjectProgress } from "@/services/dashboardService";
const stats = await fetchProjectProgress();

// ãƒãƒ¼ãƒ ç®¡ç†
import { listUsers, createUser } from "@/services/teamService";
const users = await listUsers();

// ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
import { generateReport } from "@/services/reportService";
const report = await generateReport(options);

// é€šçŸ¥ç®¡ç†
import { listNotifications } from "@/services/notificationService";
const notifications = await listNotifications();

// ã‚³ãƒ¡ãƒ³ãƒˆç®¡ç†
import { listComments, createComment } from "@/services/commentService";
const comments = await listComments(taskId);

// ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å±¥æ­´
import { getTaskStatusHistory } from "@/services/taskStatusHistoryService";
const history = await getTaskStatusHistory(taskId);
```

### 3. æ–°ã—ã„ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼é–¢æ•°ä½œæˆ
```typescript
// src/utils/taskAdapter.ts
export function newAdapterFunction(dbItem: DbType): UiType {
  return {
    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°
    uiField: dbItem.dbField || "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤",
    // æ—¥ä»˜å¤‰æ›
    dateField: formatDate(dbItem.dateField),
    // çŠ¶æ…‹å¤‰æ›
    statusField: mapStatusToJa(dbItem.statusField),
  };
}
```

### 4. Storeé–¢æ•°è¿½åŠ 
```typescript
// src/store/schedule.ts
export const useScheduleStore = () => ({
  // æ—¢å­˜é–¢æ•°...
  
  async newStoreFunction(params: SomeType) {
    try {
      const result = await newTaskFunction(params);
      if (result) {
        // StoreçŠ¶æ…‹æ›´æ–°
        this.updateLocalState(result);
        console.log("ä½œæ¥­å®Œäº†:", result.id);
      }
    } catch (error) {
      console.error("Storeä½œæ¥­å¤±æ•—:", error);
      throw error;
    }
  },
});
```

## ğŸš¨ æ³¨æ„äº‹é …

### 1. å‹ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†ç¦æ­¢
- `src/types/db/*.ts` ãƒ•ã‚¡ã‚¤ãƒ«ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ **çµ¶å¯¾ã«ç·¨é›†ã—ãªã„ã§ãã ã•ã„**
- ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´æ™‚ã¯ `npm run types:gen` ã§å†ç”Ÿæˆ

### 2. ç›´æ¥DBã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢
- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ `supabase.from()` ç›´æ¥å‘¼ã³å‡ºã—ç¦æ­¢
- å¿…ãšStoreã‚„Serviceãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é€šã—ã¦ã‚¢ã‚¯ã‚»ã‚¹

### 3. Mockãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ç¦æ­¢
- `createMockScheduleRepository()` ã¯ DEPRECATED
- å®Ÿéš›ã®DBã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„

### 4. ç’°å¢ƒå¤‰æ•°å¿…é ˆ
- `.env.local` ã« `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY` è¨­å®šå¿…é ˆ
- ç’°å¢ƒå¤‰æ•°ãªã—ã§ã¯DBæ¥ç¶šä¸å¯

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](../docs/database-schema.md)
- [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±åˆã‚¬ã‚¤ãƒ‰](../docs/database-guide.md)
- [èªè¨¼ã‚·ã‚¹ãƒ†ãƒ çµ±åˆã‚¬ã‚¤ãƒ‰](../docs/auth-system-guide.md)
- [ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰](../docs/migration-guide.md)
- [ã‚¿ã‚°æ©Ÿèƒ½ã‚¬ã‚¤ãƒ‰](../docs/tag-feature-guide.md)
- [ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«ã‚¬ã‚¤ãƒ‰](./coding-style.mdc)