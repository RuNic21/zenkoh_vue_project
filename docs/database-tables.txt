-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.alert_rules (
  id bigint NOT NULL DEFAULT nextval('alert_rules_id_seq'::regclass),
  project_id bigint NOT NULL,
  name text NOT NULL,
  rule_type text NOT NULL CHECK (rule_type = ANY (ARRAY['DUE_SOON'::text, 'OVERDUE'::text, 'NO_PROGRESS'::text, 'CUSTOM'::text])),
  params_json jsonb,
  is_enabled boolean NOT NULL DEFAULT true,
  notify_email text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT alert_rules_pkey PRIMARY KEY (id),
  CONSTRAINT alert_rules_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id)
);
CREATE TABLE public.board_columns (
  id bigint NOT NULL DEFAULT nextval('board_columns_id_seq'::regclass),
  board_id bigint NOT NULL,
  name text NOT NULL,
  wip_limit integer,
  sort_order integer NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT board_columns_pkey PRIMARY KEY (id),
  CONSTRAINT board_columns_board_id_fkey FOREIGN KEY (board_id) REFERENCES public.boards(id)
);
CREATE TABLE public.boards (
  id bigint NOT NULL DEFAULT nextval('boards_id_seq'::regclass),
  project_id bigint NOT NULL,
  name text NOT NULL,
  is_default boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT boards_pkey PRIMARY KEY (id),
  CONSTRAINT boards_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id)
);
CREATE TABLE public.notifications (
  id bigint NOT NULL DEFAULT nextval('notifications_id_seq'::regclass),
  project_id bigint NOT NULL,
  task_id bigint,
  alert_rule_id bigint,
  to_email text NOT NULL,
  subject text NOT NULL,
  body_text text NOT NULL,
  send_after timestamp with time zone NOT NULL DEFAULT now(),
  sent_at timestamp with time zone,
  status text NOT NULL DEFAULT 'QUEUED'::text CHECK (status = ANY (ARRAY['QUEUED'::text, 'SENT'::text, 'FAILED'::text, 'CANCELLED'::text])),
  last_error text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT notifications_pkey PRIMARY KEY (id),
  CONSTRAINT notifications_task_id_fkey FOREIGN KEY (task_id) REFERENCES public.tasks(id),
  CONSTRAINT notifications_alert_rule_id_fkey FOREIGN KEY (alert_rule_id) REFERENCES public.alert_rules(id),
  CONSTRAINT notifications_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id)
);
CREATE TABLE public.projects (
  id bigint NOT NULL DEFAULT nextval('projects_id_seq'::regclass),
  name text NOT NULL,
  description text,
  start_date date,
  end_date date,
  owner_user_id bigint,
  is_archived boolean NOT NULL DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT projects_pkey PRIMARY KEY (id),
  CONSTRAINT projects_owner_user_id_fkey FOREIGN KEY (owner_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.task_members (
  task_id bigint NOT NULL,
  user_id bigint NOT NULL,
  role text NOT NULL DEFAULT 'CONTRIBUTOR'::text CHECK (role = ANY (ARRAY['OWNER'::text, 'CONTRIBUTOR'::text, 'REVIEWER'::text])),
  CONSTRAINT task_members_pkey PRIMARY KEY (task_id, user_id),
  CONSTRAINT task_members_task_id_fkey FOREIGN KEY (task_id) REFERENCES public.tasks(id),
  CONSTRAINT task_members_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.tasks (
  id bigint NOT NULL DEFAULT nextval('tasks_id_seq'::regclass),
  project_id bigint NOT NULL,
  parent_task_id bigint,
  wbs_code text,
  task_name text NOT NULL,
  description text,
  primary_assignee_id bigint,
  status text NOT NULL DEFAULT 'NOT_STARTED'::text CHECK (status = ANY (ARRAY['NOT_STARTED'::text, 'IN_PROGRESS'::text, 'BLOCKED'::text, 'DONE'::text, 'CANCELLED'::text])),
  priority text NOT NULL DEFAULT 'MEDIUM'::text CHECK (priority = ANY (ARRAY['LOW'::text, 'MEDIUM'::text, 'HIGH'::text, 'URGENT'::text])),
  planned_start timestamp with time zone,
  planned_end timestamp with time zone,
  actual_start timestamp with time zone,
  actual_end timestamp with time zone,
  progress_percent smallint NOT NULL DEFAULT 0 CHECK (progress_percent >= 0 AND progress_percent <= 100),
  current_column_id bigint,
  sort_order integer,
  is_archived boolean NOT NULL DEFAULT false,
  created_by bigint,
  updated_by bigint,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT tasks_pkey PRIMARY KEY (id),
  CONSTRAINT tasks_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT tasks_parent_task_id_fkey FOREIGN KEY (parent_task_id) REFERENCES public.tasks(id),
  CONSTRAINT tasks_primary_assignee_id_fkey FOREIGN KEY (primary_assignee_id) REFERENCES public.users(id),
  CONSTRAINT tasks_current_column_id_fkey FOREIGN KEY (current_column_id) REFERENCES public.board_columns(id),
  CONSTRAINT tasks_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id),
  CONSTRAINT tasks_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.users(id)
);
CREATE TABLE public.users (
  id bigint NOT NULL DEFAULT nextval('users_id_seq'::regclass),
  email text NOT NULL UNIQUE,
  display_name text NOT NULL,
  password_hash text NOT NULL,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT users_pkey PRIMARY KEY (id)
);